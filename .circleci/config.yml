defaults: &defaults
  working_directory: ~/props
  docker:
    - image: circleci/ruby:2.5.1-node-browsers
      environment:
        - RAILS_ENV=test
    - image: circleci/postgres:latest
      environment:
        - POSTGRES_USER=props
        - POSTGRES_HOST_AUTH_METHOD=trust

version: 2.1

orbs:
  aws-cli: circleci/aws-cli@0.1.13
  aws-code-deploy: circleci/aws-code-deploy@0.0.7
  aws-ecr: circleci/aws-ecr@6.3.0

jobs:
  build:
    <<: *defaults
    steps:
      - checkout
      - attach_workspace:
          at: ~/props
      - run: yarn
      - run: bundle install --jobs=4 --retry=3 --path vendor/bundle --without development
      - persist_to_workspace:
          root: .
          paths:
            - vendor/bundle
            - node_modules

  run_tests:
    <<: *defaults
    steps:
      - checkout
      - attach_workspace:
          at: ~/props
      - run: bundle --path vendor/bundle --without development
      - run: cp config/database.yml.sample config/database.yml
      - run: bundle exec rake db:create db:schema:load --trace
      - run: bundle exec rake db:migrate
      - run: yarn test
      - run: bundle exec rspec --colour --profile 10 --order rand spec --format progress

  build_image:
    <<: *defaults
    steps:
      - run:
          name: 'set ENV for deploying staging'
          command: |
            echo 'export AWS_ACCESS_KEY_ID=$STAGING_AWS_ACCESS_KEY_ID' >> $BASH_ENV;
            echo 'export AWS_SECRET_ACCESS_KEY=$STAGING_AWS_SECRET_ACCESS_KEY' >> $BASH_ENV;
            source $BASH_ENV
      - aws-ecr/build-and-push-image:
          aws-access-key-id: AWS_ACCESS_KEY_ID
          aws-secret-access-key: AWS_SECRET_ACCESS_KEY
          region: AWS_DEFAULT_REGION
          account-url: STAGING_AWS_ECR_ACCOUNT_URL
          repo: calluna-ecr-propsapp-staging
          tag: ${CIRCLE_SHA1}
          dockerfile: docker/staging/Dockerfile
          setup-remote-docker: true

  deploy_to_staging:
    working_directory: ~/props
    executor: aws-cli/default
    steps:
      - run:
          name: 'set ENV for deploying staging'
          command: |
            echo 'export AWS_ACCESS_KEY_ID=$STAGING_AWS_ACCESS_KEY_ID' >> $BASH_ENV;
            echo 'export AWS_SECRET_ACCESS_KEY=$STAGING_AWS_SECRET_ACCESS_KEY' >> $BASH_ENV;
            source $BASH_ENV
      - checkout
      - run:
          name: Configure deployment
          command: |
            echo IMAGE=${STAGING_AWS_ECR_ACCOUNT_URL}:${CIRCLE_SHA1} >> codedeploy/parameters
      - aws-cli/install
      - aws-code-deploy/push-bundle:
          application-name: calluna-propsapp-staging-main_app
          bundle-bucket: calluna-bucket-propsapp-staging
          bundle-key: codedeploy/$CIRCLE_PROJECT_REPONAME-$CIRCLE_BUILD_NUM
      - aws-code-deploy/deploy-bundle:
          application-name: calluna-propsapp-staging-main_app
          deployment-group: calluna-propsapp-staging-main_app-group
          bundle-bucket: calluna-bucket-propsapp-staging
          bundle-key: codedeploy/$CIRCLE_PROJECT_REPONAME-$CIRCLE_BUILD_NUM

  deploy_production:
    <<: *defaults
    steps:
      - checkout
      - attach_workspace:
          at: ~/props
      - run: bundle --path vendor/bundle --without development
      - run: bundle exec cap production deploy

workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build
      - run_tests:
          requires:
            - build
      - build_image:
          requires:
            - run_tests
          filters:
            branches:
              only: master
      - deploy_to_staging:
          requires:
            - build_image
          filters:
            branches:
              only:
                - master
                - codedeploy
      - deploy_production:
          requires:
            - run_tests
          filters:
            branches:
              only: production

notify:
  webhooks:
    - url: https://webhooks.gitter.im/e/5d08569c0fcb0d849f50
